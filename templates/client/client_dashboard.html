<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client Dashboard | Oil ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" />

  <style>
    body { background-color: #f8f9fa; font-family: "Segoe UI", sans-serif; }
    .navbar-brand img { height: 40px; }

    .summary-cards {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .summary-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); text-align: center; }
    .summary-card h4 { font-size: 1.2rem; color: #0d6efd; }
    .summary-card p { font-size: 1.4rem; font-weight: bold; }

    .section-title { font-weight: 600; margin-top: 40px; margin-bottom: 20px; }

    .card-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }
    .action-card { background: #ffffff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); text-align: center; transition: all 0.3s ease; }
    .action-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
    .action-icon { font-size: 2.5rem; color: #0d6efd; margin-bottom: 15px; }

    .footer { margin-top: 50px; padding: 15px 0; background-color: #f1f1f1; text-align: center; font-size: 0.9rem; }

    .dark-mode { background-color: #121212; color: #f1f1f1; }
    .dark-mode .action-card, .dark-mode .summary-card { background-color: #1f1f1f; color: #eaeaea; }
    .dark-mode .navbar, .dark-mode .footer { background-color: #1c1c1c; color: #f1f1f1; }
    .dark-mode .btn-outline-dark { color: #fff; border-color: #ccc; }
    .dark-mode .btn-outline-dark:hover { background-color: #333; }

    .table-responsive { box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-radius: 10px; overflow: auto; }
    .table-sticky thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
    .text-money { text-align: right; white-space: nowrap; }

    /* Compact badge row on Current Delivery Info */
    .status-row .badge { margin-right: .5rem; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white px-3 shadow-sm">
  <a class="navbar-brand d-flex align-items-center" href="#">
    <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Logo" class="me-2">
  </a>
  <div class="ms-auto d-flex align-items-center">
    <button class="btn btn-outline-dark me-2" onclick="toggleDarkMode()">
      <i class="bi bi-moon"></i>
    </button>
    <a href="/logout" class="btn btn-danger">Logout</a>
  </div>
</nav>

<!-- Main Content -->
<main class="container my-5">

  <!-- ðŸ”¢ Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card">
      <h4><i class="bi bi-list-check me-1"></i> Total Orders</h4>
      <p id="sumOrders">{{ total_orders }}</p>
    </div>
    <div class="summary-card">
      <h4><i class="bi bi-cash-coin me-1"></i> Total Debt</h4>
      <p id="sumDebt">GHS {{ '%.2f'|format(total_debt) }}</p>
    </div>
    <div class="summary-card">
      <h4><i class="bi bi-wallet2 me-1"></i> Amount Paid</h4>
      <p id="sumPaid" class="text-success">GHS {{ '%.2f'|format(total_paid) }}</p>
    </div>
    <div class="summary-card">
      <h4><i class="bi bi-x-circle me-1"></i> Amount Left</h4>
      <p id="sumLeft" class="text-danger">GHS {{ '%.2f'|format(amount_left) }}</p>
    </div>
  </div>

  <!-- ðŸšš Current Delivery Info -->
  <h5 class="section-title"><i class="bi bi-truck text-primary me-2"></i>Current Delivery Info</h5>

  {% if latest_order %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <div class="mb-3 status-row">
        <i class="bi bi-info-circle text-primary me-1"></i>
        <strong>Statuses:</strong>
        <!-- Delivery status (legacy) -->
        {% set del = latest_order.delivery_status or 'pending' %}
        <span class="badge
            {% if del|lower in ['delivered','released','loaded'] %}bg-success
            {% elif del|lower in ['failed attempt','returned'] %}bg-danger
            {% else %}bg-warning text-dark{% endif %}">

        </span>
        <!-- TTS -->
        {% set tts = latest_order.tts_status or 'â€”' %}
        <span class="badge
            {% if tts|lower in ['released','loaded','approved','goodstanding'] %}bg-success
            {% elif tts|lower in ['brv check unpass','failed'] %}bg-danger
            {% else %}bg-warning text-dark{% endif %}">
          TTS: {{ tts }}
        </span>
        <!-- NPA -->
        {% set npa = latest_order.npa_status or 'â€”' %}
        <span class="badge
            {% if npa|lower in ['released','loaded','approved','goodstanding'] %}bg-success
            {% elif npa|lower in ['brv check unpass','failed'] %}bg-danger
            {% else %}bg-warning text-dark{% endif %}">
          NPA: {{ npa }}
        </span>
      </div>

      <div class="row g-3">
        <div class="col-md-6"><strong>Driver Name:</strong> {{ latest_order.driver_name or 'N/A' }}</div>
        <div class="col-md-6"><strong>Driver Phone:</strong> {{ latest_order.driver_phone or 'N/A' }}</div>
        <div class="col-md-6"><strong>Vehicle Number:</strong> {{ latest_order.vehicle_number or 'N/A' }}</div>
        <div class="col-md-6"><strong>Product:</strong> {{ latest_order.product or 'N/A' }}</div>
        <div class="col-md-6"><strong>Quantity (L):</strong> {{ latest_order.quantity or 'N/A' }}</div>
        <div class="col-md-6"><strong>Depot:</strong> {{ latest_order.depot or 'N/A' }}</div>
        <div class="col-md-6"><strong>Region:</strong> {{ latest_order.region or 'N/A' }}</div>
        <div class="col-md-6"><strong>Due Date:</strong>
          {% if latest_order.due_date %}{{ latest_order.due_date.strftime('%Y-%m-%d') }}{% else %}<span class="text-muted">N/A</span>{% endif %}
        </div>
        
      </div>
    </div>
  </div>
  {% else %}
  <div class="alert alert-warning shadow-sm">No recent delivery data available.</div>
  {% endif %}

  <!-- ðŸ“¦ Dashboard Quick Actions -->
  <div class="card-grid">
    <a href="/client/submit_order" class="action-card text-decoration-none">
      <div class="action-icon"><i class="bi bi-truck-front"></i></div>
      <div class="action-title">Submit Order</div>
      <p class="text-muted">Place a new order for oil products</p>
    </a>
    <a href="/client/order_history" class="action-card text-decoration-none">
      <div class="action-icon"><i class="bi bi-clock-history"></i></div>
      <div class="action-title">Order History</div>
      <p class="text-muted">View all your past orders and due dates</p>
    </a>
    <a href="/client/payment" class="action-card text-decoration-none">
      <div class="action-icon"><i class="bi bi-credit-card-2-front"></i></div>
      <div class="action-title">Make Payment</div>
      <p class="text-muted">Upload proof of payment for orders</p>
    </a>
  </div>

  <!-- ðŸ§¾ Recent Orders Table -->
  {% if recent_orders %}
  <h5 class="section-title"><i class="bi bi-receipt text-primary me-2"></i>Recent Orders</h5>
  <div class="table-responsive">
    <table id="recentOrdersTable" class="table table-bordered table-striped align-middle mb-0 table-sticky">
      <thead class="table-light">
        <tr class="text-nowrap">
          <th>#</th>
          <th>Order ID</th>
          <th>Product</th>
          <th>Order Type</th>
          <th>Vehicle #</th>
          <th class="text-end">Qty</th>
          <th class="text-money">Debt (GHS)</th>
          <th class="text-money">Paid (GHS)</th>
          <th class="text-money">Left (GHS)</th>
          <th>Delivery</th>
          <th>TTS</th>
          <th>NPA</th>
          <th>Delivered On</th>
        </tr>
      </thead>
      <tbody>
        {% for order in recent_orders %}
        {% set del = (order.delivery_status or 'pending') %}
        {% set tts = (order.tts_status or 'â€”') %}
        {% set npa = (order.npa_status or 'â€”') %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ order.order_id or 'N/A' }}</td>
          <td>{{ order.product }}</td>
          <td class="text-uppercase">
            {% if order.order_type == "s_bdc" %} S-BDC
            {% elif order.order_type == "s_tax" %} S-Tax
            {% elif order.order_type == "combo" %} Combo
            {% else %} â€”
            {% endif %}
          </td>
          <td>{{ order.vehicle_number }}</td>
          <td class="text-end">{{ "{:,}".format((order.quantity or 0)|int) }}</td>
          <td class="text-money debt-cell">{{ '%.2f'|format(order.total_debt or 0) }}</td>
          <td class="text-money paid-cell">{{ '%.2f'|format(order.amount_paid or 0) }}</td>
          <td class="text-money left-cell">0.00</td>
          <!-- Delivery badge -->
          <td>
            <span class="badge
              {% if del|lower in ['delivered','released','loaded'] %}bg-success
              {% elif del|lower in ['failed attempt','returned'] %}bg-danger
              {% else %}bg-warning text-dark{% endif %}">
              {{ del|capitalize }}
            </span>
          </td>
          <!-- TTS badge -->
          <td>
            <span class="badge
              {% if tts|lower in ['released','loaded','approved','goodstanding'] %}bg-success
              {% elif tts|lower in ['brv check unpass','failed'] %}bg-danger
              {% elif tts == 'â€”' %}bg-secondary
              {% else %}bg-warning text-dark{% endif %}">
              {{ tts }}
            </span>
          </td>
          <!-- NPA badge -->
          <td>
            <span class="badge
              {% if npa|lower in ['released','loaded','approved','goodstanding'] %}bg-success
              {% elif npa|lower in ['brv check unpass','failed'] %}bg-danger
              {% elif npa == 'â€”' %}bg-secondary
              {% else %}bg-warning text-dark{% endif %}">
              {{ npa }}
            </span>
          </td>
          <td>
            {% if order.delivered_date %}
              {{ order.delivered_date.strftime('%Y-%m-%d') }}
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

</main>

<!-- Footer -->
<footer class="footer">
  Â© 2025 Oil ERP | Powered by CYTECH
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
  }

  // ðŸ‘‰ Helper: parse a money-ish string to Number safely
  function parseMoney(txt) {
    if (!txt) return 0;
    const clean = String(txt).replace(/[^0-9.-]/g, '');
    const n = Number(clean);
    return isFinite(n) ? n : 0;
  }

  // ðŸ‘‰ Helper: format to en-GH and force 2dp
  const ghFmt = new Intl.NumberFormat('en-GH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  function fmtMoney(n) { return ghFmt.format(Number(n || 0)); }

  // âœ… Compute Amount Left per row (Debt - Paid) and update summary card as JS truth
  (function computeLeft() {
    const table = document.getElementById('recentOrdersTable');
    if (!table) return;

    let sumDebt = 0, sumPaid = 0;

    table.querySelectorAll('tbody tr').forEach(tr => {
      const debtCell = tr.querySelector('.debt-cell');
      const paidCell = tr.querySelector('.paid-cell');
      const leftCell = tr.querySelector('.left-cell');

      const debt = parseMoney(debtCell?.textContent || '0');
      const paid = parseMoney(paidCell?.textContent || '0');
      const left = debt - paid;

      sumDebt += debt;
      sumPaid += paid;

      if (leftCell) leftCell.textContent = fmtMoney(left);
      if (debtCell) debtCell.textContent = fmtMoney(debt);
      if (paidCell) paidCell.textContent = fmtMoney(paid);

      if (leftCell && left < 0) {
        leftCell.classList.add('text-success');
      }
    });

    const sumDebtEl = document.getElementById('sumDebt');
    const sumPaidEl = document.getElementById('sumPaid');
    const sumLeftEl = document.getElementById('sumLeft');

    if (sumDebtEl) sumDebtEl.textContent = 'GHS ' + fmtMoney(sumDebt);
    if (sumPaidEl) sumPaidEl.textContent = 'GHS ' + fmtMoney(sumPaid);
    if (sumLeftEl) sumLeftEl.textContent = 'GHS ' + fmtMoney(sumDebt - sumPaid);
  })();

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      const evt = new Event('recalc-left');
      window.dispatchEvent(evt);
    }
  });
</script>

</body>
</html>
